{% extends "base.html" %}

{% block head_title %}
  This is so Cool!
{% endblock %}

{% block content %}
  <div class="row">
    <div class="col text-center mb-4">
      <h1>Welcome to Tweetme 2</h1>
    </div>
  </div>

  <div class="row mb-3">
    <div class="col-10 col-md-4 mx-auto">
      <form id="tweet-create-form" method="POST" action="/create-tweet" class="form">
        {% csrf_token %}
        <input type="hidden" name="next" value="/" />
        <textarea class="form-control" name="content" placeholder="Your Tweet..."></textarea>
        <button class="btn btn-primary" type="submit">Tweet</button>
      </form>
    </div>
  </div>

  <div class="row" id="tweets">
    replace me
  </div>

  <script type="text/javascript">
   const tweetCreateForm = document.getElementById("tweet-create-form")
   const tweetsEl = document.getElementById("tweets")
   // tweetsElements.innerHTML("Loading...")

   function handleTweetCreateFormDidSubmit(event) {
     event.preventDefault()
     const myForm = event.target
     const myFormData = new FormData(myForm)
     const url = myForm.getAttribute("action")
     const method = myForm.getAttribute("method")
     const xhr = new XMLHttpRequest()
     xhr.open(method, url)
     xhr.setRequestHeader("HTTP_X_REQUESTED_WITH", "XMLHttpRequest")
     xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest")
     xhr.onload = function() {
       const serverResponse = xhr.response
       console.log(xhr.status, serverResponse)
       const tweetsEl = document.getElementById("tweets")
       loadTweets(tweetsEl)
     }
     xhr.send(myFormData)
   }

   tweetCreateForm.addEventListener("submit", handleTweetCreateFormDidSubmit)


   function handleDidLike(tweet_id, currentCount) {
     console.log(tweet_id, currentCount)
   }

   function likeButton(tweet){
     return `<button class="btn btn-primary btn-small" onclick="handleDidLike(${tweet.id}, ${tweet.likes})">${tweet.likes} Likes</button>`
   }

   function formatTweet(tweet) {
     return `<div class="col-12 col-md-10 mx-auto border rounded py-3 mb-4 tweet" id="tweet-${tweet.id}"><p>${tweet.content}</p><div class="btn-group">
${likeButton(tweet)}</div></div>`
   }

   function loadTweets(tweetsElements) {
     const xhr = new XMLHttpRequest()
     const method = "GET"
     const url = "/tweets"
     const responseType = "json"
     xhr.responseType = responseType
     xhr.open(method, url)
     xhr.onload = function(){
       const serverResponse = xhr.response
       const listItems = serverResponse.response
       let finalTweets = ""
       for (var i=0; i<listItems.length; i++) {
         var tweetObj = listItems[i]
         var currentTweet = formatTweet(tweetObj)
         finalTweets += currentTweet
       }
       tweetsElements.innerHTML = finalTweets
     }
     xhr.send()
   }

   loadTweets(tweetsEl)
  </script>

{% endblock %}
